extends ../layouts/dashboard.pug

block config
    - var bodyClass = 'sb-nav-fixed'
    - var pageTitle = 'Dashboard';
    - var index = false;
    - var sidenavStyle = 'sb-sidenav-dark'
    
prepend css
    //- Load Simple DataTables Stylesheet
    link(href='https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css', rel='stylesheet')
    link( rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css",integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==",crossorigin="") 
    script( src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js", integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==", crossorigin="")
    script(src="https://code.jquery.com/jquery-3.6.0.min.js",integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=",crossorigin="anonymous")
block content
    //button(id="new") Add new point
    #map(style={height: '1000px'})
    script.
        function timeConverter(UNIX_timestamp){
            var a = new Date(UNIX_timestamp * 1000);
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            var year = a.getFullYear();
            var month = months[a.getMonth()];
            var date = a.getDate();
            var hour = a.getHours();
            var min = a.getMinutes();
            var sec = a.getSeconds();
            var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;
            return time;
        }
        var mymap = L.map('map').setView([38.8898, -77.044], 14);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: 'pk.eyJ1IjoibmJ1cnkiLCJhIjoiY2t2cmk5cWZvNGdveDJ0bnU4N2k2eHl4NSJ9.nfPDUZJDa1wPD2v5LhF8qg',
        }).addTo(mymap);
        var matches = []
        const requestOptions = {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'My-Custom-Header': 'foobar'
            },  
            body: JSON.stringify({ title: 'Fetch PUT Request Example' })
        }
        function getData(){

            fetch('test.json').then(response => response.text()).then(data => {
                d = JSON.parse(data);
                m = d.matches;
                for (var i = 0; i < m.length; i++) {
                    console.log(m[i]);
                    if (!matches.includes(m[i].id)){
                        var marker = L.marker(
                            L.latLng(parseFloat(m[i].x_coord), parseFloat(m[i].y_coord))
                        ).addTo(mymap).bindPopup("<img width=\"150\" src=\"assets/"+m[i].image_name+"\" /> <br/>"+timeConverter(parseInt(m[i].time)));
                        
                        matches.push(m[i].id)
                    }
                }
            })
        };
        getData()
        setInterval(getData,1000)